---
title: "S05-create_plots"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{S05-create_plots}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>", 
  root.dir = "~/Documents/Pedersen2023/Peaks/lextremagam"
)
```

```{r setup}
library(lextremagam)
library(ggplot2)
library(dplyr)
```

#Import all sim data 
```{r}
setwd("~/Documents/Pedersen2023/Peaks/lextremagam")
rds_sim <- list.files("data-raw/sim/analy_results/", full.names = TRUE)
for (i in rds_sim ){
    readRDS(i)}

#merging earlier sim tests into a single summary list
e1_4_summary_ad <- list(e1 = e1_summary, 
                        e2 = e2_summary, 
                        e3 = e3_summary, 
                        e4 = e4_summary)
saveRDS(e1_4_summary_ad, "data-raw/sim/analy_results/e1_4_summary_adjalpha.RDS")
```

#Simulation plot
```{r}
sim_dat_e1 <- read_parquet("data-raw/sim/data/sim_dat_e1.parquet")
sim_dat_e1_ex <- filter(sim_dat_e1, rep == 1)
sim_dat_e2 <- read_parquet("data-raw/sim/data/sim_dat_e2.parquet")
sim_dat_e2_ex <- filter(sim_dat_e2, rep == 1)
sim_dat_e3 <- read_parquet("data-raw/sim/data/sim_dat_e3_e50.parquet")
sim_dat_e3_ex <- filter(sim_dat_e3, rep == 1)
sim_dat_e4 <- read_parquet("data-raw/sim/data/sim_dat_e4.parquet")
sim_dat_e4_ex <- filter(sim_dat_e4, rep == 1)

#needs work
sim1_data_plot <- ggplot(data=sim_dat_e1_ex)+
  geom_line(aes(x=x, y=y_true, group = func))+
  geom_point(aes(x=x, y=y, colour = dup))+
  facet_wrap(~as.factor(func))

sim2_data_plot <- ggplot(data=filter(sim_dat_e2_ex, error > .14& error < 0.16 | error >.49& error <.51 | error >0.94 ))+
  geom_line(aes(x=x, y=y_true))+
  geom_line(aes(x=x, y=y_true+error, group = as.factor(error), colour=error))+
  geom_line(aes(x=x, y=y_true-error, group = as.factor(error), colour=error))+
  scale_color_gradientn(colors = c( "#c6dbef", "#6baed6", "#2171b5"))+
  labs(title = "Simulation Experiment 2", x = "x", y = "y")+
  theme_bw()+
  facet_grid(func~.)


sim3_data_plot <- ggplot(filter(sim_dat_e3_ex, (func == "var-p-location" &(param <=.051 | param >.49& param <.51 | param >0.94 ))|
                                 ( func == "var-p-skew" & (param < .16 | param >.84 | param >.49& param <.51))|
                                  (func == "var-p-width" & (param <=.051 |param >0.29 & param <0.31 | param >0.94))))+
  geom_line(aes(x=x, y=y_true, group = as.factor(param), color = param))+
  scale_color_gradientn(colors = c( "#6baed6", "#2171b5", "#084594"))+
  labs(title = "Simulation Experiment 3", x = "x", y = "y")+
  theme_bw()+
  facet_wrap(~func)

sim4_data_plot <- ggplot(filter(sim_dat_e4_ex, (func == "var-location" &(param <=.051 | param >.49& param <.51 | param >0.94 ))|
                                 ( func == "var-curvature" & (param < .26 | param >.94 | param >.49& param <.51))|
                                  (func == "var-scale" & (param < .26 | param >.94 | param >.49& param <.51))))+
  geom_line(aes(x=x, y=y_true, group = as.factor(param), color = param))+
  scale_color_gradientn(colors = c( "#6baed6", "#2171b5", "#084594"))+
  labs(title = "Simulation Experiment 4", x = "x", y = "y")+
  theme_bw()+
  facet_wrap(~func)



```

#plot Type I error

```{r}

fpe_plot_data <- dplyr::filter(tidyr::pivot_longer(e4_summary$fperror, cols = c("quad", "rprop", "pr_gr"), names_to = "method", values_to = "fperror"),
                                          func == "var-location", dup %in% c(1,5))
fpe_plot_data$func <- as.factor(fpe_plot_data$func)
fpe_plot_data$dup <- as.factor(fpe_plot_data$dup)

fperror_plot <- ggplot(data=fpe_plot_data)+
  geom_point(aes(x=param, y=fperror, colour=method))+
  geom_line(aes(x=param, y=fperror, colour=method))+
  geom_hline(aes(yintercept=0.05), linetype=2)+
  labs( x = "midpoint ", y = "Type I error rate")+
  scale_color_discrete(labels = c("lextremagam", "quadratic test", "two-lines test"))+
  theme_bw()+
  facet_wrap(~dup, labeller = labeller(dup = c("1" = "n[dup] == 1", "5" = "n[dup] == 5"), .default = label_parsed))

```

#plot power
```{r}
power_plot_data <- dplyr::filter(tidyr::pivot_longer(e3_summary$power, cols = c("quad", "rprop", "pr_gr"), names_to = "method", values_to = "power"),
                                          func == "var-p-skew", dup %in% c(1,5))
power_plot_data$func <- as.factor(power_plot_data$func)
power_plot_data$dup <- as.factor(power_plot_data$dup)
power_plot_data$peak <-  (power_plot_data$param*10-1)/(power_plot_data$param*10+(10-power_plot_data$param*10)-2)

power_plot <- ggplot(data=power_plot_data)+
  geom_point(aes(x=peak, y=power, colour=method))+
  geom_line(aes(x=peak, y=power, colour=method))+
  labs( x = "peak location ", y = "Power rate")+
  scale_color_discrete(labels = c("lextremagam", "quadratic test", "two-lines test"))+
  theme_bw()+
  facet_wrap(~dup, labeller = labeller(dup = c("1" = "n[dup] == 1", "5" = "n[dup] == 5"), .default = label_parsed))
```

#coverage plot
```{r}
cov_plot_data <- dplyr::filter(e3_summary$coverage, func == "var-p-skew")
cov_plot_data$func <- as.factor(cov_plot_data$func)
cov_plot_data$dup <- as.factor(cov_plot_data$dup)
cov_plot_data$peak <-  (cov_plot_data$param*10-1)/(cov_plot_data$param*10+(10-cov_plot_data$param*10)-2)

cov_plot <- ggplot(data=cov_plot_data)+
  geom_point(aes(x=peak, y=coverage_gr, colour = dup))+
  geom_line(aes(x=peak, y=coverage_gr, colour = dup))+
  geom_hline(aes(yintercept=0.95), linetype=2)+
  labs( x = "peak location ", y = "Coverage rate", colour = "number of duplicates")+
  scale_colour_manual(values = c("#cce5ff", "#99ccff", "#66b2ff", "#3399ff", "#0073e6"))+
  theme_bw()

cov_plot

cov_plot_data2 <- dplyr::filter(e3_summary$coverage, func == "var-p-width")
cov_plot_data2$func <- as.factor(cov_plot_data2$func)
cov_plot_data2$dup <- as.factor(cov_plot_data2$dup)
cov_plot_data2$peak <-  0.5

cov_plot2 <- ggplot(data=cov_plot_data2)+
  geom_point(aes(x=param, y=coverage_gr, colour = dup))+
  geom_line(aes(x=param, y=coverage_gr, colour = dup))+
  geom_hline(aes(yintercept=0.95), linetype=2)+
  labs( x = "peak width parameter", y = "Coverage rate", colour = "number of duplicates")+
  scale_colour_manual(values = c("#cce5ff", "#99ccff", "#66b2ff", "#3399ff", "#0073e6"))+
  theme_bw()
```

#no need for CI width I don't think
```{r}

```

#bias
```{r}
#MUST USE CORRECTED BIAS ALL DATA ******
bias_all_data <- readRDS("~/Documents/Pedersen2023/Peaks/lextremagam/data-raw/sim/analy_results/bias_all_data.RDS")

bias_plot_data <- dplyr::filter(bias_all_data$e1_3_bias_ad$e3_bias, func == "var-p-skew")
bias_plot_data$func <- as.factor(bias_plot_data$func)
bias_plot_data$dup <- as.factor(bias_plot_data$dup)
bias_plot_data$se <- bias_plot_data$bias_sd_gr_max/sqrt(bias_plot_data$n_gr)

ggplot(data=bias_plot_data)+
  geom_ribbon(aes(x = peak, ymin=bias_avg_gr_max-bias_sd_gr_max, ymax=bias_avg_gr_max+bias_sd_gr_max, group = dup), fill="#cce5ff", alpha=0.3)+
  geom_point(aes(x=peak, y=bias_avg_gr_max, colour=dup))+
  geom_line(aes(x=peak, y=bias_avg_gr_max, colour=dup))+
  geom_hline(aes( yintercept=0), linetype=2)+
  labs( x = "peak location ", y = "Coverage rate", colour = "number of duplicates", fill = "Standard Error")+
  scale_colour_manual(values = c("#cce5ff", "#99ccff", "#66b2ff", "#3399ff", "#0073e6"))+
  #scale_fill_manual(values = c("#cce5ff"))+
  theme_bw()

ggplot(data=bias_plot_data)+
  geom_ribbon(aes(x = peak, ymin=bias_avg_gr_max-se, ymax=bias_avg_gr_max+se, group = dup), fill="#cce5ff", alpha=0.3)+
  geom_point(aes(x=peak, y=bias_avg_gr_max, colour=dup))+
  geom_line(aes(x=peak, y=bias_avg_gr_max, colour=dup))+
  geom_hline(aes( yintercept=0), linetype=2)+
  labs( x = "peak location ", y = "Bias", colour = "number of duplicates", fill = "Standard Error")+
  scale_colour_manual(values = c("#cce5ff", "#99ccff", "#66b2ff", "#3399ff", "#0073e6"))+
  #scale_fill_manual(values = c("#cce5ff"))+
  theme_bw()
```

```{r}

```

```{r}

```

```{r}

```
#Power
```{r}
plot_power <- function(summary, title){
    e1_p <- ggplot(data=tidyr::pivot_longer(summary$e1$power, cols = c("quad", "rprop", "pr_gr"), names_to = "method", values_to = "power"))+
  geom_point(aes(x=dup, y=power, colour=method))+
  geom_line(aes(x=dup, y=power, colour=method))+
  labs(title = paste0("Exp 1 P,  ", title))
  
e2_p <- ggplot(data=tidyr::pivot_longer(summary$e2$power, cols = c("quad", "rprop", "pr_gr"), names_to = "method", values_to = "power"))+
  geom_point(aes(x=error, y=power, colour=method))+
  geom_line(aes(x=error, y=power, colour=method))+
  labs(title = paste0("Exp 2 P,  ", title))

e3_p_1 <- ggplot(data=filter(tidyr::pivot_longer(summary$e3$power, cols = c("quad", "rprop", "pr_gr"), names_to = "method", values_to = "power"), func!="var-p-width"))+
  geom_point(aes(x=peak, y=power, colour=method))+
  geom_line(aes(x=peak, y=power, colour=method))+
  facet_grid(dup~func)+
  labs(title = paste0("Exp 3 P,  ", title))
  
e3_p_2 <- ggplot(data=filter(tidyr::pivot_longer(e1_4_summary_adjalpha_ad$e3$power, cols = c("quad", "rprop", "pr_gr"), names_to = "method", values_to = "power"), func=="var-p-width"))+
  geom_point(aes(x=param, y=power, colour=method))+
  geom_line(aes(x=param, y=power, colour=method))+
  facet_grid(dup~func)+
  labs(title = paste0("Exp 3 P,  ", title))

return(list(e1_fpe = e1_p, e2_p = e2_p, e3_p_1 = e3_p_1, e3_p_2 = e3_p_2))
}

p_adaptive <- plot_power(e1_4_summary_ad, "Adaptive Spline, Alpha = 0.05")
p_tprs <- plot_power(e1_4_summary_tprs, "TPRS, Alpha = 0.05")
p_adaptive_adj <- plot_power(e1_4_summary_adjalpha_ad, "Adaptive Spline, Alpha = sqrt(0.05)")
p_tprs_adj <- plot_power(e1_4_summary_adjalpha, "TPRS, Alpha = sqrt(0.05)")


pdf("power_plots.pdf")
p_adaptive
p_tprs
p_adaptive_adj
p_tprs_adj
dev.off()

```




pdf("e1_4_tprs_adj_ad_plots.pdf")
#POWER ####
ggplot(data=tidyr::pivot_longer(e1_4_summary_adjalpha_ad$e1$power, cols = c("quad", "rprop", "pr_gr"), names_to = "method", values_to = "power"))+
  geom_point(aes(x=dup, y=power, colour=method))+
  geom_line(aes(x=dup, y=power, colour=method))

ggplot(data=tidyr::pivot_longer(e1_4_summary_adjalpha_ad$e2$power, cols = c("quad", "rprop", "pr_gr"), names_to = "method", values_to = "power"))+
  geom_point(aes(x=error, y=power, colour=method))+
  geom_line(aes(x=error, y=power, colour=method))

ggplot(data=filter(tidyr::pivot_longer(e1_4_summary_adjalpha_ad$e3$power, cols = c("quad", "rprop", "pr_gr"), names_to = "method", values_to = "power"), func!="var-p-width"))+
  geom_point(aes(x=peak, y=power, colour=method))+
  geom_line(aes(x=peak, y=power, colour=method))+
  facet_grid(dup~func)
ggplot(data=filter(tidyr::pivot_longer(e1_4_summary_adjalpha_ad$e3$power, cols = c("quad", "rprop", "pr_gr"), names_to = "method", values_to = "power"), func=="var-p-width"))+
  geom_point(aes(x=param, y=power, colour=method))+
  geom_line(aes(x=param, y=power, colour=method))+
  facet_grid(dup~func)


# COVERAGE ####
ggplot(data=e1_4_summary_adjalpha_ad$e1$coverage)+
  geom_point(aes(x=dup, y=coverage_gr))+
  geom_line(aes(x=dup, y=coverage_gr))+
  geom_hline(aes(yintercept=0.95), linetype=2)

ggplot(data=e1_4_summary_adjalpha_ad$e2$coverage)+
  geom_point(aes(x=error, y=coverage_gr))+
  geom_line(aes(x=error, y=coverage_gr))+
  geom_hline(aes(yintercept=0.95), linetype=2)

ggplot(data=filter(e1_4_summary_adjalpha_ad$e3$coverage, func!="var-p-width"))+
  geom_point(aes(x=peak, y=coverage_gr, colour=as.factor(dup)))+
  geom_line(aes(x=peak, y=coverage_gr, colour=as.factor(dup)))+
  geom_hline(aes(yintercept=0.95), linetype=2)+
  facet_wrap(~func)

ggplot(data=filter(e1_4_summary_adjalpha_ad$e3$coverage, func=="var-p-width"))+
  geom_point(aes(x=param, y=coverage_gr, colour=as.factor(dup)))+
  geom_line(aes(x=param, y=coverage_gr, colour=as.factor(dup)))+
  geom_hline(aes(yintercept=0.95), linetype=2)+
  facet_wrap(~func)

#PRECISION ####
ggplot(data=e1_4_summary_adjalpha_ad$e1$precision)+
  geom_point(aes(x=dup, y=width_avg_gr))+
  geom_line(aes(x=dup, y=width_avg_gr))+
  geom_ribbon(aes(x = dup, ymin=width_avg_gr-width_sd_gr, ymax=width_avg_gr+width_sd_gr), alpha=0.2)

ggplot(data=e1_4_summary_adjalpha_ad$e2$precision)+
  geom_point(aes(x=error, y=width_avg_gr))+
  geom_line(aes(x=error, y=width_avg_gr))+
  geom_ribbon(aes(x = error, ymin=width_avg_gr-width_sd_gr, ymax=width_avg_gr+width_sd_gr), alpha=0.2)

ggplot(data=filter(e1_4_summary_adjalpha_ad$e3$precision, func !="var-p-width"))+
  geom_point(aes(x=peak, y=width_avg_gr, colour=as.factor(dup)))+
  geom_line(aes(x=peak, y=width_avg_gr, colour=as.factor(dup)))+
  geom_ribbon(aes(x = peak, ymin=width_avg_gr-width_sd_gr, ymax=width_avg_gr+width_sd_gr, fill=as.factor(dup)), alpha=0)+
  facet_wrap(~func)

ggplot(data=filter(e1_4_summary_adjalpha_ad$e3$precision, func =="var-p-width"))+
  geom_point(aes(x=param, y=width_avg_gr, colour=as.factor(dup)))+
  geom_line(aes(x=param, y=width_avg_gr, colour=as.factor(dup)))+
  geom_ribbon(aes(x = param, ymin=width_avg_gr-width_sd_gr, ymax=width_avg_gr+width_sd_gr, fill=as.factor(dup)), alpha=0)+
  facet_wrap(~func)

# BIAS ####
ggplot(data=filter(e1_4_summary_adjalpha_ad$e1$bias, func== "norm"))+
  geom_point(aes(x=dup, y=bias_avg_gr))+
  geom_line(aes(x=dup, y=bias_avg_gr))+
  geom_ribbon(aes(x = dup, ymin=bias_avg_gr-bias_sd_gr, ymax=bias_avg_gr+bias_sd_gr), alpha=0.2)+
  geom_hline(aes( yintercept=0), linetype=2)

ggplot(data=filter(e1_4_summary_adjalpha_ad$e2$bias, func== "norm"))+
  geom_point(aes(x=error, y=bias_avg_gr))+
  geom_line(aes(x=error, y=bias_avg_gr))+
  geom_ribbon(aes(x = error, ymin=bias_avg_gr-bias_sd_gr, ymax=bias_avg_gr+bias_sd_gr), alpha=0.2)+
  geom_hline(aes(yintercept=0), linetype=2)

ggplot(data=filter(e1_4_summary_adjalpha_ad$e3$bias, func!= "var-p-width"))+
  geom_point(aes(x=peak, y=bias_avg_gr, colour=as.factor(dup)))+
  geom_line(aes(x=peak, y=bias_avg_gr, colour=as.factor(dup)))+
  geom_ribbon(aes(x = peak, ymin=bias_avg_gr-bias_sd_gr, ymax=bias_avg_gr+bias_sd_gr, fill=as.factor(dup)), alpha=0.1)+
  geom_hline(aes( yintercept=0), linetype=2)+
facet_wrap(~func)

ggplot(data=filter(e1_4_summary_adjalpha_ad$e3$bias, func== "var-p-width"))+
  geom_point(aes(x=param, y=bias_avg_gr, colour=as.factor(dup)))+
  geom_line(aes(x=param, y=bias_avg_gr, colour=as.factor(dup)))+
  geom_ribbon(aes(x = param, ymin=bias_avg_gr-bias_sd_gr, ymax=bias_avg_gr+bias_sd_gr, fill=as.factor(dup)), alpha=0.1)+
  geom_hline(aes( yintercept=0), linetype=2)+
facet_wrap(~func)

dev.off()



